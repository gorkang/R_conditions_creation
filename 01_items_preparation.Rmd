# Items preparation

## Presentation formats

### Natural Frequency

```{r, read_nfab}
# path to responses folder
nfab_items_dir <- "materials/Presentation format/FN absolute/"

# responses files
nfab_item_files <- dir(nfab_items_dir, pattern = ".txt")

# paths to each response file
nfab_item_files_path <- paste0(nfab_items_dir, nfab_item_files)

# list with responses as char strings
nfab_items <- lapply(nfab_item_files_path, 
                    function(x) readChar(con = x, nchars = file.info(x)$size)) 

# assing name to each response type
names(nfab_items) <- gsub(".txt", "", nfab_item_files)
```

### Positive framework

```{r, read_pfab}
# path to responses folder
pfabitems_dir <- "materials/Presentation format/Positive-framework/"

# responses files
pfabitem_files <- dir(pfabitems_dir, pattern = ".txt")

# paths to each response file
pfabitem_files_path <- paste0(pfabitems_dir, pfabitem_files)

# list with responses as char strings
pfabitems <- lapply(pfabitem_files_path, 
                    function(x) readChar(con = x, nchars = file.info(x)$size))

# assing name to each response type
names(pfabitems) <- gsub(".txt", "", pfabitem_files)

```

### Probability Absolute

```{r, read_prab}
# path to responses folder
prab_items_dir <- "materials/Presentation format/PR absolute/"

# responses files
prab_item_files <- dir(prab_items_dir, pattern = ".txt")

# paths to each response file
prab_item_files_path <- paste0(prab_items_dir, prab_item_files)

# list with responses as char strings
prab_items <- lapply(prab_item_files_path, 
                    function(x) readChar(con = x, nchars = file.info(x)$size))

# assing name to each response type
names(prab_items) <- gsub(".txt", "", prab_item_files)
```

### Probability Relative

```{r, read_prnf}
# path to responses folder
prrl_items_dir <- "materials/Presentation format/PR relative/"

# responses files
prrl_item_files <- dir(prrl_items_dir, pattern = ".txt")

# paths to each response file
prrl_item_files_path <- paste0(prrl_items_dir, prrl_item_files)

# list with responses as char strings
prrl_items <- lapply(prrl_item_files_path, 
                    function(x) readChar(con = x, nchars = file.info(x)$size))

# assing name to each response type
names(prrl_items) <- gsub(".txt", "", prrl_item_files)
```

### Fact-box

```{r, read_fb}
# Read fact-box template
fact_box <- image_read('materials/Presentation format/Fact-boxs/fact_box_blank.png')
```

### New paradigm

```{r}
# Read new paradigm Brochure
new_paradigm = image_read('materials/Presentation format/New-paradigm/brochure/png/short_brochure_blank.png')  
```

## Bind all textual presentation formats

```{r}
problems <- c(nfab_items, pfabitems, prab_items, prrl_items)
```

## Numbers sets
+ Combine every context with every set?
+ Two number sets (NF, PR). If we convert NF to PR we only get one set of numbers per normative PPV.

```{r}
# read csv with number
numbers_item <-
  read_csv("materials/Numbers/numbers_bayes.csv", col_types = cols())
```

## Create items

### Create textual items (combine items with numbers)
```{r}
numbers2problems(problems)
problems_numbered %>% str

```

### Create pictoric items

#### Fact-box

```{r}
# Create list with the image the number of times of numbers sets available to factbox
fb_items <- list(NULL)

# Loop to repeat image
for (numbers_list in seq(nrow(filter(numbers_item, format == "factbox")))){fb_items[[numbers_list]] <- fact_box};rm(numbers_list)  #short loop to repeat current PROBLEM from LOOP 1

# Position of pieces in the image
pieces_pos <- c("+550+261.54", # R1C1
                "+550+303", # R2C1
                "+706+261.54", # R1C2
                "+706+303", # R2C2
                "+719+385", # R3C2
                "+719+430") # R4C2

# position of columnes in numbers
num_pos <- 4:9

# filter numbers to keep factbox numbers
numbers_fact <- filter(numbers_item, format == "factbox")

for (fact_box_loop in seq(length(fb_items))) { # LOOP: number of images (aka number of set of numbers)
  # fact_box_loop=1
  
  item2number <- fb_items[[fact_box_loop]] # current item to put numbers on it
  
  for (numbers_pos_loop in seq(length(pieces_pos))) { # LOOP: number of numbers to put into the image
    # numbers_loop=4
    
    item2number <-
      image_annotate(item2number, numbers_fact[[fact_box_loop, num_pos[numbers_pos_loop]]], size = 15, color = "black", boxcolor = "", # ROW 1
                     degrees = 0, location = pieces_pos[numbers_pos_loop])
    
  }
  
  # Create name of current item
  current_item_name <- paste(
    numbers_fact[fact_box_loop, "format"],
    numbers_fact[fact_box_loop, "prob"],
    sep="_"
  )
  
  # Save numbered item with name in the master list. 
  fb_items[[fact_box_loop]] <-
    setNames(as.list(item2number), current_item_name)

  # Clean lopp rubish
  if (fact_box_loop == length(fb_items)) {
    rm(fact_box_loop, numbers_pos_loop, current_item_name, item2number, numbers_fact)
  }
    
}

# Write images
for (i in seq(length(fb_items))) {
  image_write(fb_items[[i]][[1]], paste0("materials/Presentation format/Fact-boxs/complete_factboxs/", names(fb_items[[i]]), ".png"))
  if (i == length(fb_items)) rm(i)
}




```

#### New-paradigm

```{r}
# graphs dir
graph_dir <- "materials/Presentation format/New-paradigm/graphs/png/"

# get graphs file names
np_graphs_files_names <- grep("ppv.*png", dir(graph_dir), value = TRUE)

# Read graphs into list
np_graphs <- lapply(np_graphs_files_names, function(x) image_read(paste0(graph_dir, x)))

# list with prevalences
prevalences <- list("100", "1000")

# cat prevalences with " births."
np_prevalences <- lapply(prevalences, function(x) paste0(x, " births."))

# Function to insert graphics and prevalences on brochure. It takes two lists, one with graphs "x" and one with prevalences "y".
# Both, graphs and prevalences are inserted synchronously (first arguments of each, second.., third...)
assemble_brochure <- function(x,y) {
  image_annotate(image_composite(new_paradigm, x, offset = "+70+730"), y, font = "arial", size = 21, color = "black", boxcolor = "",
                 degrees = 0, location = "+96+386")
}

# Assemble brochure
np_items <- mapply(assemble_brochure, x=np_graphs, y=np_prevalences)

# List with names for brochure files
np_names <- list("pinp_low", "pinp_high")

# Write images
mapply(function(x,y) {image_write(x, paste0("materials/Presentation format/New-paradigm/brochure_complete/", y, ".png"))}, x=np_items, y=np_names)
```



## Reorder items

```{r}

items_to_use <- 
c(
  
# LOW PPV PROBLEMS
c(
problems_numbered[[1]][[1]]
,problems_numbered[[2]][[1]]
,problems_numbered[[3]][[1]]
,problems_numbered[[4]][[1]]
,problems_numbered[[5]][[1]]
,problems_numbered[[6]][[1]]
,problems_numbered[[7]][[1]]
,problems_numbered[[8]][[1]]
),

# HIGH PPV PROBLEMS
c(
problems_numbered[[1]][[2]]
,problems_numbered[[2]][[2]]
,problems_numbered[[3]][[2]]
,problems_numbered[[4]][[2]]
,problems_numbered[[5]][[2]]
,problems_numbered[[6]][[2]]
,problems_numbered[[7]][[2]]
,problems_numbered[[8]][[2]]
)

)
```



## Response types
```{r}
# path to responses folder
response_types_dir <- "materials/Response_type/"

# responses files
response_type_files <- dir(response_types_dir)

# paths to each response file
response_type_files_path <- paste0(response_types_dir, response_type_files)

# list with responses as char strings
responses <- lapply(response_type_files_path, 
                    function(x) readChar(con = x, nchars = file.info(x)$size))

# assing name to each response type
names(responses) <- gsub(".txt", "", response_type_files)

# Response types
invisible(lapply(responses, cat))

```

## Combine textual problems with questions

```{r}
items_to_use_responses <-
lapply(items_to_use, function(x) 
  paste0(x, lapply(responses, paste0)))

responses_names <- names(responses)

for (problem_loop in 1:length(items_to_use_responses)) {
# problem_loop=1  
  for (item_loop in 1:length(items_to_use_responses[[problem_loop]])) {
    # item_loop=1
    
    # Add response bit to condition string
    items_to_use_responses[[problem_loop]][[item_loop]] <- 
      gsub("([w|h])\\*\\*\n", paste0("\\1_", responses_names[item_loop], "**\n"), items_to_use_responses[[problem_loop]][[item_loop]])
  
    }
  
}

```

```{r}
items_to_use_responses %>% str
```
